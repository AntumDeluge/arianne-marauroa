var marauroa=new function(){};marauroa.debug={messages:false,unknownEvents:true};marauroa.log={};
if(typeof console!="undefined"&&typeof console.debug!="undefined"){marauroa.log.debug=function(){console.debug.apply(console,arguments)};marauroa.log.info=function(){console.info.apply(console,arguments)};marauroa.log.warn=function(){console.warn.apply(console,arguments)};marauroa.log.error=function(){console.error.apply(console,arguments)}}else{marauroa.log.debug=function(text){};marauroa.log.info=function(text){};marauroa.log.warn=function(text){};marauroa.log.error=function(text){alert(text)}}
marauroa.util={isEmpty:function(obj){for(var i in obj)if(obj.hasOwnProperty(i))return false;return true},isEmptyExceptId:function(obj){for(var i in obj)if(i!="id"&&obj.hasOwnProperty(i))return false;return true},first:function(obj){for(var i in obj)return obj[i]},fromProto:function(proto){var f=function(){this.proto=proto};f.prototype=proto;return new f}};String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")};marauroa.clientFramework={clientid:"-1",connect:function(host,port){var options={};if(window.location.protocol=="https:"){options.port=443;options.secure=true}if(typeof port!="undefined"&&port!=null)options.port=port;var socket=new io.Socket(host,options);socket.setMessageParser(socket.JSON_MESSAGE,{encode:function(obj){return JSON.stringify(obj)},decode:function(str){return JSON.parse(str)}});socket.connect();var temp=this;socket.on("message",function(mtype,obj){if(mtype==socket.JSON_MESSAGE)temp.onMessage(obj)});
socket.on("connect",this.onConnect);socket.on("disconnect",this.onDisonnect);this.socket=socket},onConnect:function(reason,error){if(typeof error=="undefined")marauroa.log.debug("connected");else marauroa.log.error("onConnect: "+reason+" error: "+error)},onDisconnect:function(reason,error){marauroa.log.debug("onDisconnect: "+reason+" error: "+error)},onLoginRequired:function(){},login:function(username,password){var msg={"t":"34","u":username,"p":password};this.username=username;this.sendMessage(msg)},
onServerInfo:function(contents){marauroa.log.debug("ServerInfo",contents)},onPreviousLogins:function(previousLogins){marauroa.log.debug("Previous Logins",previousLogins)},onLoginFailed:function(reason,text){marauroa.log.error("Login failed with reason "+reason+": "+text)},onMessage:function(msg){if(marauroa.debug.messages)marauroa.log.debug("<--: ",msg);if(msg.t==9||msg.t==15)this.clientid=msg.c;if(typeof msg=="string")marauroa.log.error("JSON error on message: "+msg);else{marauroa.messageFactory.addDispatchMethod(msg);
msg.dispatch()}},sendMessage:function(msg){var myMessage={"c":this.clientid,"s":"1"};io.util.merge(myMessage,msg);if(marauroa.debug.messages)marauroa.log.debug("--\>: ",msg);this.socket.send(JSON.stringify(myMessage))},resync:function(){},chooseCharacter:function(character){var msg={"t":"1","character":character};this.sendMessage(msg)},onChooseCharacterNack:function(){marauroa.log.error("Server rejected your character.")},sendAction:function(action){var msg={"t":"0","a":action};this.sendMessage(msg)},
logout:function(){var msg={"t":"5"};this.sendMessage(msg)},onLogoutOutAck:function(){marauroa.log.debug("Server accepted logout request")},onLogoutOutNack:function(){marauroa.log.debug("Server rejected logout request")},close:function(){this.socket.close()},onPerception:function(perceptionMessage){marauroa.perceptionHandler.apply(perceptionMessage)},onTransferREQ:function(items){marauroa.log.debug("onTransferREQ: ",items)},onTransfer:function(items){marauroa.log.debug("onTransfer: ",items)},onAvailableCharacterDetails:function(characters){marauroa.log.debug("onAvailableCharacterDetails: ",
characters);if(marauroa.util.isEmpty(characters)){marauroa.log.debug("No character found, creating a character with the username (redefine onAvailableCharacterDetails to prevent this).");this.createCharacter(this.username,{});return}for(key in characters)if(characters.hasOwnProperty(key))this.chooseCharacter(key)},createAccount:function(username,password,email){var msg={"t":"23","u":username,"p":password,"e":email};this.sendMessage(msg)},onCreateAccountAck:function(username){marauroa.log.debug('Account "'+
username+'" created successfully.')},onCreateAccountNack:function(username,reason){marauroa.log.debug('Creating Account "'+username+'" failed: ',reason);alert(reason.text)},createCharacter:function(charname,template){var msg={"t":"26","charname":charname,"template":template};this.sendMessage(msg)},onCreateCharacterAck:function(charname,template){marauroa.log.debug('Character "'+charname+'" created successfully.')},onCreateCharacterNack:function(charname,reason){marauroa.log.debug('Creating Character "'+
charname+'" failed: ',reason);alert(reason.text)}};if(!this.JSON)JSON=function(){function f(n){return n<10?"0"+n:n}Date.prototype.toJSON=function(){return this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z"};var m={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};function stringify(value,whitelist){var a,i,k,l,r=/["\\\x00-\x1f\x7f-\x9f]/g,v;switch(typeof value){case "string":return r.test(value)?'"'+value.replace(r,
function(a){var c=m[a];if(c)return c;c=a.charCodeAt();return"\\u00"+Math.floor(c/16).toString(16)+(c%16).toString(16)})+'"':'"'+value+'"';case "number":return isFinite(value)?String(value):"null";case "boolean":case "null":return String(value);case "object":if(!value)return"null";if(typeof value.toJSON==="function")return stringify(value.toJSON());a=[];if(typeof value.length==="number"&&!value.propertyIsEnumerable("length")){l=value.length;for(i=0;i<l;i+=1)a.push(stringify(value[i],whitelist)||"null");
return"["+a.join(",")+"]"}if(whitelist){l=whitelist.length;for(i=0;i<l;i+=1){k=whitelist[i];if(typeof k==="string"){v=stringify(value[k],whitelist);if(v)a.push(stringify(k)+":"+v)}}}else for(k in value)if(typeof k==="string"){v=stringify(value[k],whitelist);if(v)a.push(stringify(k)+":"+v)}return"{"+a.join(",")+"}"}}return{stringify:stringify,parse:function(text,filter){var j;function walk(k,v){var i,n;if(v&&typeof v==="object")for(i in v)if(Object.prototype.hasOwnProperty.apply(v,[i])){n=walk(i,v[i]);
if(n!==undefined)v[i]=n}return filter(k,v)}if(/^[\],:{}\s]*$/.test(text.replace(/\\./g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof filter==="function"?walk("",j):j}throw new SyntaxError("parseJSON");}}}();marauroa.messageFactory=new function(){this.t14=function(){marauroa.clientFramework.onLoginFailed(this.reason,this.text)};this.t9=function(){marauroa.clientFramework.onAvailableCharacterDetails(this.characters)};this.t10=function(){marauroa.log.debug("Entering world")};this.t11=function(){marauroa.log.debug("Character selection rejected");marauroa.clientFramework.onChooseCharacterNack()};this.t13=function(){marauroa.clientFramework.onPreviousLogins(this.previousLogins)};this.t15=function(){marauroa.log.debug("Server send key: ",
this);marauroa.clientFramework.onLoginRequired()};this.t19=function(){marauroa.clientFramework.onPerception(this)};this.t20=function(){marauroa.clientFramework.onServerInfo(this.contents)};this.t21=function(){alert(this)};this.t22=function(){marauroa.clientFramework.onTransferREQ(this.contents);var contents={};for(var i in this.contents)if(typeof this.contents[i].ack!="undefined"&&this.contents[i].ack)contents[this.contents[i].name]=true;else contents[this.contents[i].name]=false;var msg={"t":"7",
"contents":contents};marauroa.clientFramework.sendMessage(msg)};this.t24=function(){marauroa.clientFramework.onCreateAccountAck(this.username)};this.t25=function(){marauroa.clientFramework.onCreateAccountNack(this.username,this.reason)};this.t27=function(){marauroa.clientFramework.onCreateCharacterAck(this.charname,this.template)};this.t28=function(){marauroa.clientFramework.onCreateCharacterNack(this.charname,this.reason)};this.unknownMessage=function(){marauroa.log.debug("Unknown message: "+JSON.stringify(this))};
this.addDispatchMethod=function(msg){if(typeof marauroa.messageFactory["t"+msg.t]!="undefined")msg.dispatch=marauroa.messageFactory["t"+msg.t];else msg.dispatch=marauroa.messageFactory.unknownMessage}};marauroa.rpobjectFactory=new function(){this._default=function(){};this._default.onEvent=function(e){var event=marauroa.rpeventFactory.create(e.c);for(var i in e.a){if(e.a.hasOwnProperty(i))event[i]=e.a[i];event._rpclass=e.c}event.execute(this)};this._default.set=function(key,value){this[key]=value};this._default.setMapEntry=function(map,key,value){this[map][key]=value};this._default.unset=function(key){delete this[key]};this._default.unsetMapEntry=function(map,key){delete this[map][key]};this._default.destroy=
function(parent){};this._default.createSlot=function(name){return marauroa.rpslotFactory.create(name)};this.create=function(rpclass){var ctor=this._default;if(typeof this[rpclass]!="undefined")ctor=this[rpclass];return marauroa.util.fromProto(ctor)}};
marauroa.rpeventFactory=new function(){this._default=function(){};this._default.execute=function(rpobject){if(marauroa.debug.unknownEvents)marauroa.log.debug("Unhandled event: ",this," on ",rpobject)};this.create=function(rpclass){var ctor=this._default;if(typeof this[rpclass]!="undefined")ctor=this[rpclass];return marauroa.util.fromProto(ctor)}};
marauroa.rpslotFactory=new function(){this._default=function(){};this._default.add=function(key,value){this[key]=value};this._default.del=function(key){delete this[key]};this._default.first=function(){for(var i in this)if(!isNaN(i))return this[i]};this.create=function(name){var ctor=this._default;if(typeof this[name]!="undefined")ctor=this[name];return marauroa.util.fromProto(ctor)}};marauroa.perceptionListener={onAdded:function(object){return false},onModifiedAdded:function(object,changes){return false},onModifiedDeleted:function(object,changes){return false},onDeleted:function(object){return false},onMyRPObject:function(added,deleted){return false},onClear:function(){return false},onPerceptionBegin:function(type,timestamp){},onPerceptionEnd:function(type,timestamp){},onException:function(exception,perception){marauroa.log.error(exception,perception)}};
marauroa.currentZone={clear:function(){for(var i in this)if(this.hasOwnProperty(i)&&typeof this[i]!="function")delete this[i]}};
marauroa.perceptionHandler={apply:function(msg){marauroa.perceptionListener.onPerceptionBegin(msg.sync,msg.s);if(msg.sync)if(!marauroa.perceptionListener.onClear()){marauroa.currentZone.clear();marauroa.currentZoneName=msg.zoneid}this.applyPerceptionAddedRPObjects(msg);this.applyPerceptionModifiedRPObjects(msg);this.applyPerceptionDeletedRPObjects(msg);this.applyPerceptionMyRPObject(msg);marauroa.perceptionListener.onPerceptionEnd(msg.sync,msg.s)},applyPerceptionAddedRPObjects:function(msg){if(msg.aO)for(var i in msg.aO)if(msg.aO.hasOwnProperty(i))if(!marauroa.perceptionListener.onAdded(msg.aO[i])){var o=
marauroa.rpobjectFactory.create(msg.aO[i].c);this.addChanges(o,msg.aO[i]);marauroa.currentZone[msg.aO[i].a.id]=o}},applyPerceptionDeletedRPObjects:function(msg){if(msg.dO)for(var i in msg.dO)if(msg.dO.hasOwnProperty(i)){var tmp=msg.dO[i].a.id;if(!marauroa.perceptionListener.onDeleted(msg.dO[i])){marauroa.currentZone[tmp].destroy(marauroa.currentZone);delete marauroa.currentZone[tmp]}}},applyPerceptionModifiedRPObjects:function(msg){if(msg.dA)for(var i in msg.dA)if(msg.dA.hasOwnProperty(i))if(typeof marauroa.currentZone[msg.dA[i].a.id]!=
"undefined"){var o=marauroa.currentZone[msg.dA[i].a.id];if(!marauroa.perceptionListener.onModifiedDeleted(msg.dA[i]))this.deleteChanges(o,msg.dA[i])}if(msg.aA)for(var i in msg.aA)if(msg.aA.hasOwnProperty(i))if(typeof marauroa.currentZone[msg.aA[i].a.id]!="undefined"){var o=marauroa.currentZone[msg.aA[i].a.id];if(!marauroa.perceptionListener.onModifiedAdded(o,msg.aA[i]))this.addChanges(o,msg.aA[i])}},applyPerceptionMyRPObject:function(msg){if(!marauroa.perceptionListener.onMyRPObject(msg.aM,msg.dM)){var id;
if(typeof msg.aM!="undefined")id=msg.aM.a.id;if(typeof msg.dM!="undefined")id=msg.dM.a.id;if(typeof id=="undefined")return;this.addMyRPObjectToWorldIfPrivate(id,msg.aM);var o=marauroa.currentZone[id];marauroa.me=o;this.deleteChanges(o,msg.dM);this.addChanges(o,msg.aM)}},addMyRPObjectToWorldIfPrivate:function(id,added){if(typeof marauroa.currentZone[id]!="undefined")return;if(!marauroa.perceptionListener.onAdded(added)){if(typeof added=="undefined"){marauroa.currentZone[id]={};return}var o=marauroa.rpobjectFactory.create(added.c);
marauroa.currentZone[id]=o;this.addChanges(o,added)}},deleteChanges:function(object,diff){if(typeof diff=="undefined")return;if(typeof diff.a!="undefined")for(var i in diff.a)if(diff.a.hasOwnProperty(i)&&i!="id"&&i!="zoneid")object.unset(i);if(typeof diff.s!="undefined")for(var i in diff.s){if(!diff.s.hasOwnProperty(i))continue;if(marauroa.util.isEmpty(diff.s[i]))object.del(diff.s[i]);else for(var j in diff.s[i])if(diff.s[i].hasOwnProperty(j))object[i].del(diff.s[i][j].a.id)}if(typeof diff.m!="undefined")for(var i in diff.m){if(!diff.m.hasOwnProperty(i))continue;
if(marauroa.util.isEmpty(diff.m[i].a))object.unset(diff.m[i]);else for(var j in diff.m[i].a)if(diff.m[i].a.hasOwnProperty(j))object.unsetMapEnty(i,diff.m[i].a[j])}},addChanges:function(object,diff){if(typeof diff=="undefined")return;object._rpclass=diff.c;for(var i in diff.a)if(diff.a.hasOwnProperty(i))if(typeof object.set=="undefined"){marauroa.log.warn("Object missing set(key, value)-function",object,diff.a);object[i]=diff.a[i]}else object.set(i,diff.a[i]);if(typeof diff.m!="undefined")for(var i in diff.m)if(diff.m.hasOwnProperty(i)){if(typeof object[i]==
"undefined")object[i]={};for(var j in diff.m[i].a)if(j!="zoneid"&&j!="id"&&diff.m[i].a.hasOwnProperty(j))object.setMapEntry(i,j,diff.m[i].a[j])}if(typeof diff.s!="undefined")for(var i in diff.s)if(diff.s.hasOwnProperty(i)){if(typeof object[i]=="undefined")object[i]=object.createSlot(i);for(var j in diff.s[i])if(diff.s[i].hasOwnProperty(j)){var id=diff.s[i][j].a.id;if(typeof object[i][id]=="undefined")object[i].add(id,marauroa.rpobjectFactory.create(diff.s[i][j].c));this.addChanges(object[i][id],diff.s[i][j])}}if(typeof diff.e!=
"undefined"&&typeof object.onEvent!="undefined")for(var i in diff.e)if(diff.e.hasOwnProperty(i))object.onEvent(diff.e[i])}};
